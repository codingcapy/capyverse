import{u as S,a as k,j as e,r as x,d as F,F as ee,i as te,I as ne,R as se,c as oe,k as ae,l as re}from"./index-CeKz0IzP.js";import{u as M,a as $}from"./index-B0yj2ae6.js";import{b as de,u as ie,c as le,e as ce,f as me,h as ue,i as xe,F as fe,j as J,k as pe,l as he,d as W,g as ve,M as ge,V as je}from"./comments-DmR5usBr.js";import{g as _}from"./users-Bp6QgJ-N.js";import{d as z}from"./capypaul01-dN7xfBcC.js";function Ce(t){const{data:a,isLoading:l,isError:c}=M(de(t.comment.commentId)),{mutate:m,isPending:i}=ie(),{mutate:h,isPending:C}=le(),{user:r}=S(),v=k();function g(n,d,b,f){if(n.preventDefault(),n.stopPropagation(),i||C)return;const I=a&&a.find(j=>r&&j.userId===r.userId);r&&I?h({voteId:I.voteId,value:f}):r?m({userId:r&&r.userId||"",postId:d.postId,commentId:b.commentId,value:f}):v({to:"/login"})}return e.jsx("div",{children:c?e.jsx("div",{children:"Error fetching votes"}):l?e.jsx("div",{children:"Loading..."}):a?e.jsxs("div",{className:"flex w-fit rounded-full py-1 justify-center",children:[a.filter(n=>r&&n.userId===r.userId&&n.value===1).length>0?e.jsx("div",{onClick:n=>{n.stopPropagation(),n.preventDefault(),h({voteId:a.find(d=>d.postId===t.post.postId&&r&&d.userId===r.userId&&d.value===1).voteId,value:0})},className:"pr-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(ce,{size:20})}):e.jsx("div",{onClick:n=>{g(n,t.post,t.comment,1)},className:"pr-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(me,{size:20})}),e.jsx("div",{className:"",children:a.filter(n=>n.postId===t.post.postId).reduce((n,d)=>n+d.value,0)}),a.filter(n=>r&&n.userId===r.userId&&n.value===-1).length>0?e.jsx("div",{onClick:n=>{n.stopPropagation(),n.preventDefault(),h({voteId:a.find(d=>d.postId===t.post.postId&&r&&d.userId===r.userId&&d.value===-1).voteId,value:0})},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(ue,{size:20})}):e.jsx("div",{onClick:n=>{g(n,t.post,t.comment,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(xe,{size:20})})]}):e.jsx("div",{children:"An unexpected error has occured"})})}function be(t){const a=x.useRef(null),{user:l}=S(),{setEditCommentModePointer:c}=F();k();function m(i){a.current&&!a.current.contains(i.target)&&t.setShowMenu(!1)}return x.useEffect(()=>(document.addEventListener("click",m),()=>document.removeEventListener("click",m)),[]),e.jsxs("div",{ref:a,className:"absolute top-12 right-2 py-2 px-5 rounded bg-[#222222] shadow-[0_0_15px_rgba(0,0,0,0.7)] z-40",children:[l&&t.comment.userId===l.userId&&e.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[e.jsx(fe,{size:20,className:"pt-1"}),e.jsx("div",{onClick:()=>{c(t.comment.commentId),t.setCommentContent(t.comment.content||""),t.setShowMenu(!1)},className:"ml-2",children:"Edit"})]}),e.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[e.jsx(ee,{size:20,className:"pt-1"}),e.jsx("div",{className:"ml-2",children:"Save"})]}),l&&t.comment.userId===l.userId&&e.jsxs("div",{onClick:i=>{i.stopPropagation(),i.preventDefault(),t.setDeleteMode(!0),t.setShowMenu(!1)},className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[e.jsx(te,{size:20,className:"pt-1 "}),e.jsx("div",{className:"ml-2",children:"Delete"})]})]})}function G(t){const[a,l]=x.useState(!1),{user:c}=S(),[m,i]=x.useState(""),{mutate:h,isPending:C}=J(),r=k(),[v,g]=x.useState(!1),[n,d]=x.useState(!1),{mutate:b,isPending:f}=pe(),{editCommentModePointer:I,setEditCommentModePointer:j}=F(),{mutate:P,isPending:N}=he();function y(s){if(s.preventDefault(),!c)return r({to:"/login"});const D=c.userId;h({userId:D,postId:t.post.postId,parentCommentId:t.comment.commentId,level:t.comment.level+1,content:m},{onSuccess:()=>{i(""),l(!1)}})}function E(s){if(s.preventDefault(),!c)return r({to:"/login"});P({commentId:t.comment.commentId,content:m},{onSuccess:()=>{j(0),i("")}})}return e.jsxs("div",{className:"my-3",style:{marginLeft:window.innerWidth>760?t.comment.level*25:t.comment.level*10},children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[e.jsx("div",{className:"font-bold",children:t.comment.username}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:W(t.post.createdAt)})]}),I===t.comment.commentId?e.jsxs("form",{onSubmit:E,className:"pl-5 py-2 my-5 rounded-2xl border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300",children:[e.jsx("input",{type:"text",placeholder:"Add your reply",className:"outline-none w-full",value:m,onChange:s=>i(s.target.value),required:!0}),e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:s=>{s.stopPropagation(),j(0)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{disabled:N,className:"mx-2 px-2 py-1 rounded-full bg-red-500 cursor-pointer",children:N?"Saving...":"Save Edits"})]})]}):e.jsx("div",{children:t.comment.content}),e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"mr-3",children:e.jsx(Ce,{post:t.post,comment:t.comment})}),e.jsxs("div",{onClick:()=>{c||r({to:"/login"}),i(""),l(!0)},className:"flex ml-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:[e.jsx(ne,{size:22}),e.jsx("div",{className:"ml-2",children:"Reply"})]}),c&&t.comment.userId===c.userId&&e.jsxs("div",{className:"relative",children:[e.jsx("div",{onClick:s=>{s.preventDefault(),s.stopPropagation(),g(!v)},className:"ml-3 px-2 pt-1.5 rounded-full hover:text-cyan-700 transition-all ease-in-out duration-300 cursor-pointer",children:e.jsx($,{})}),v&&e.jsx(be,{comment:t.comment,setDeleteMode:d,setShowMenu:g,setCommentContent:i})]})]}),a&&e.jsxs("form",{onSubmit:y,className:`pl-5 py-2 my-5 ${a?"rounded-2xl":"rounded-full"} border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300`,children:[e.jsx("input",{type:"text",placeholder:"Add your reply",className:"outline-none w-full",value:m,onChange:s=>i(s.target.value),required:!0}),e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:s=>{s.stopPropagation(),l(!1)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{disabled:C,className:"mx-2 px-2 py-1 rounded-full bg-red-500 cursor-pointer",children:C?"Creating...":"Comment"})]})]}),n&&e.jsxs("div",{className:"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-[#222222] p-6 rounded shadow-lg w-[90%] max-w-md text-center z-100",children:[e.jsx("div",{className:"text-2xl font-bold",children:"Delete Comment?"}),e.jsx("div",{className:"my-5",children:"Once you delete this comment, it can’t be restored."}),e.jsxs("div",{className:"my-5 flex justify-end",children:[e.jsx("div",{onClick:s=>{s.stopPropagation(),s.preventDefault(),!f&&(b({commentId:t.comment.commentId}),d(!1))},className:"p-2 mr-1 bg-red-500 rounded text-white bold secondary-font font-bold cursor-pointer",children:f?"Deleting...":"DELETE"}),e.jsx("div",{onClick:s=>{s.stopPropagation(),s.preventDefault(),d(!1)},className:"p-2 ml-1 bg-[#5c5c5c] rounded bold secondary-font font-bold cursor-pointer",children:"CANCEL"})]})]}),n&&e.jsx("div",{className:"fixed inset-0 bg-black opacity-50 z-90"}),t.comment.children?.map(s=>e.jsx(G,{comment:s,post:t.post},s.commentId))]},t.comment.commentId)}function Me(){const t=se.useRouteContext(),{user:a}=S(),{data:l,isLoading:c,error:m}=M(ve(t.postId)),{data:i,isLoading:h,error:C}=M(_(t.userId)),[r,v]=x.useState(""),{mutate:g,isPending:n}=J(),d=k(),[b,f]=x.useState(!1),I=X(l&&l||[]),[j,P]=x.useState(!1),[N,y]=x.useState(!1),{mutate:E,isPending:s}=oe(),{editPostModePointer:D,setEditPostModePointer:R}=F(),{mutate:H,isPending:V}=ae(),[T,O]=x.useState(t.content),U=re(),{data:L,isLoading:K}=M(_(t.userId));function X(o,q){const A=new Map;for(const u of o)A.set(u.commentId,{...u,children:[]});const w=[];for(const u of o){const p=A.get(u.commentId);if(u.parentCommentId==null){w.push(p);continue}const Q=A.get(u.parentCommentId);if(!Q){w.push(p);continue}Q.children.push(p)}const Z=(u,p)=>u.createdAt.getTime()-p.createdAt.getTime();function B(u){u.sort(Z);for(const p of u)p.children.length&&B(p.children)}return B(w),w}function Y(o){if(o.preventDefault(),n)return;if(!a)return d({to:"/login"});const q=a.userId;g({userId:q,postId:t.postId,content:r},{onSuccess:()=>{v(""),f(!1)}})}return e.jsxs("div",{className:"pt-[70px] mx-auto w-full lg:w-[50%]",children:[e.jsxs("div",{className:"relative flex justify-between",children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[e.jsx("img",{src:K?z:L?L.profilePic?L.profilePic:z:z,alt:"",className:"w-8 h-8 rounded-full"}),h?e.jsx("div",{className:"ml-2",children:"Loading..."}):C?e.jsx("div",{children:"Error loading author"}):i?e.jsx("div",{className:"font-bold ml-2",children:i.username}):e.jsx("div",{className:"ml-2",children:"unknown author"}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:W(t.createdAt)})]}),e.jsx("div",{className:"",children:e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),P(!j)},className:" absolute top-1 right-1 p-3 rounded-full hover:bg-[#575757] transition-all ease-in-out duration-300",children:e.jsx($,{})})}),j&&e.jsx(ge,{post:t,setDeleteMode:y,setShowMenu:P})]}),e.jsxs("div",{className:"text-4xl font-bold",children:[" ",t.title]}),D===t.postId?e.jsxs("div",{children:[e.jsx("textarea",{name:"content",id:"content",required:!0,className:"p-2 border border-[#c4c4c4] rounded my-2 w-full h-[300px]",placeholder:"content",value:T,onChange:o=>O(o.target.value)}),e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:o=>{o.stopPropagation(),R(0)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{onClick:()=>{V||H({postId:t.postId,content:T},{onSuccess:()=>{U.invalidate(),R(0)}})},className:"mx-2 px-2 py-1 rounded-full bg-cyan-700",children:V?"Saving...":"Save"})]})]}):e.jsx("div",{className:"my-10",children:e.jsx("div",{children:t.content})}),e.jsx(je,{post:t}),e.jsxs("form",{onClick:()=>{a||d({to:"/login"}),f(!0)},onSubmit:Y,className:`pl-5 py-2 my-5 ${b?"rounded-2xl":"rounded-full"} border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300`,children:[e.jsx("input",{type:"text",placeholder:"Join the conversation",value:r,onChange:o=>v(o.target.value),required:!0,className:"outline-none w-full"}),b&&e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:o=>{o.stopPropagation(),f(!1)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{disabled:n,className:"mx-2 px-2 py-1 rounded-full bg-red-500 cursor-pointer",children:n?"Submitting...":"Comment"})]})]}),a&&t.userId===a.userId&&N&&e.jsxs("div",{className:"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-[#222222] p-6 rounded shadow-lg w-[90%] max-w-md text-center z-100",children:[e.jsx("div",{className:"text-2xl font-bold",children:"Delete Post?"}),e.jsx("div",{className:"my-5",children:"Once you delete this post, it can’t be restored."}),e.jsxs("div",{className:"my-5 flex justify-end",children:[e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),!s&&E({postId:t.postId},{onSuccess:()=>{U.invalidate(),y(!1),O("[This post has been deleted by the user]")}})},className:"p-2 mr-1 bg-red-500 rounded text-white bold secondary-font font-bold cursor-pointer",children:s?"Deleting...":"DELETE"}),e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),y(!1)},className:"p-2 ml-1 bg-[#5c5c5c] rounded bold secondary-font font-bold cursor-pointer",children:"CANCEL"})]})]}),a&&t.userId===a.userId&&N&&e.jsx("div",{className:"fixed inset-0 bg-black opacity-50 z-90"}),m?e.jsx("div",{children:"Error loading comments"}):c?e.jsx("div",{children:"Loading..."}):I.map(o=>e.jsx(G,{comment:o,post:t},o.commentId))]})}export{Me as component};
