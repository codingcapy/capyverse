import{q as y,c as C,d as w,e as j,u as I,a as g,j as e,R as b,r as N}from"./index-Cjde8ODs.js";import{u as h,g as P,a as E,b as A,P as S,c as F,e as V,f as D,d as f,V as k}from"./utils-akGWZxtv.js";import{g as q}from"./users-DWS-pKye.js";function Q(t){return{...t,createdAt:new Date(t.createdAt)}}async function M(t){const o=await j.api.v0.comments.$post({json:t});if(!o.ok){let c="There was an issue creating your comment :( We'll look into it ASAP!";try{const i=await o.json();i&&typeof i=="object"&&"message"in i&&(c=String(i.message))}catch(i){console.error("Failed to parse error response:",i)}throw new Error(c)}return await o.json()}const R=t=>{const o=C();return w({mutationFn:M,onSettled:()=>{o.invalidateQueries({queryKey:["comments"]})},onError:d=>{}})};async function z(t){const o=await j.api.v0.comments[":postId"].$get({param:{postId:t.toString()}});if(!o.ok)throw new Error("Error getting comments by id");const{comments:d}=await o.json();return d.map(Q)}const B=t=>y({queryKey:["comments",t],queryFn:()=>z(t)});function O(t){const{data:o,isPending:d,isError:c}=h(P(t.comment.commentId)),{mutate:i}=E(),{mutate:u}=A(),{user:n}=I(),p=g();function l(s,r,x,m){s.preventDefault(),s.stopPropagation();const a=o&&o.find(v=>n&&v.userId===n.userId);n&&a?u({voteId:a.voteId,value:m}):n?i({userId:n&&n.userId||"",postId:r.postId,commentId:x.commentId,value:m}):p({to:"/login"})}return e.jsx("div",{children:c?e.jsx("div",{children:"Error fetching votes"}):d?e.jsx("div",{children:"Loading..."}):e.jsxs("div",{className:"flex w-fit rounded-full py-1 justify-center",children:[o.filter(s=>n&&s.userId===n.userId&&s.value===1).length>0?e.jsx("div",{onClick:s=>{s.stopPropagation(),s.preventDefault(),u({voteId:o.find(r=>r.postId===t.post.postId&&n&&r.userId===n.userId&&r.value===1).voteId,value:0})},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(S,{size:20})}):e.jsx("div",{onClick:s=>{l(s,t.post,t.comment,1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(F,{size:20})}),e.jsx("div",{className:"",children:o.filter(s=>s.postId===t.post.postId).reduce((s,r)=>s+r.value,0)}),o.filter(s=>n&&s.userId===n.userId&&s.value===-1).length>0?e.jsx("div",{onClick:s=>{s.stopPropagation(),s.preventDefault(),u({voteId:o.find(r=>r.postId===t.post.postId&&n&&r.userId===n.userId&&r.value===-1).voteId,value:0})},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(V,{size:20})}):e.jsx("div",{onClick:s=>{l(s,t.post,t.comment,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(D,{size:20})})]})})}function T(){const t=b.useRouteContext(),{user:o}=I(),{data:d,isPending:c,error:i}=h(B(t.postId)),{data:u,isPending:n,error:p}=h(q(t.userId)),[l,s]=N.useState(""),{mutate:r}=R(),x=g();function m(a){if(a.preventDefault(),!o)return x({to:"/login"});const v=o.userId;r({userId:v,postId:t.postId,content:l},{onSuccess:()=>s("")})}return e.jsxs("div",{className:"p-20 mx-auto w-full lg:w-[50%]",children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[n?e.jsx("div",{children:"Loading..."}):p?e.jsx("div",{children:"Error loading author"}):e.jsx("div",{className:"font-bold",children:u.username}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:f(t.createdAt)})]}),e.jsxs("div",{className:"text-4xl font-bold",children:[" ",t.title]}),e.jsx("div",{className:"my-10",children:e.jsx("div",{children:t.content})}),e.jsx(k,{post:t}),e.jsx("form",{onSubmit:m,children:e.jsx("input",{type:"text",placeholder:"Add your reply",className:"px-5 py-2 my-5 rounded-full border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300",value:l,onChange:a=>s(a.target.value),required:!0})}),i?e.jsx("div",{}):c?e.jsx("div",{}):d.map(a=>e.jsxs("div",{className:"my-3",children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[e.jsx("div",{className:"font-bold",children:a.username}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:f(t.createdAt)})]}),a.content,e.jsx(O,{post:t,comment:a})]},a.commentId))]})}export{T as component};
