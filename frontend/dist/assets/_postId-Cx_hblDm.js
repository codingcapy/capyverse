import{q,c as R,d as z,e as k,G as Q,u as b,a as N,j as e,r as j,R as T}from"./index-B6bXgUjM.js";import{u as C,g as B,a as O,b as L,P as U,c as $,e as G,f as K,d as A,V as W}from"./utils-BjFiQUNU.js";import{g as J}from"./users-CnIQDlp8.js";function H(t){return{...t,createdAt:new Date(t.createdAt)}}async function X(t){const o=await k.api.v0.comments.$post({json:t});if(!o.ok){let l="There was an issue creating your comment :( We'll look into it ASAP!";try{const a=await o.json();a&&typeof a=="object"&&"message"in a&&(l=String(a.message))}catch(a){console.error("Failed to parse error response:",a)}throw new Error(l)}return await o.json()}const E=t=>{const o=R();return z({mutationFn:X,onSettled:()=>{o.invalidateQueries({queryKey:["comments"]})},onError:i=>{}})};async function Y(t){const o=await k.api.v0.comments[":postId"].$get({param:{postId:t.toString()}});if(!o.ok)throw new Error("Error getting comments by id");const{comments:i}=await o.json();return i.map(H)}const Z=t=>q({queryKey:["comments",t],queryFn:()=>Y(t)});function _(t){return Q({attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{fill:"none",strokeLinecap:"round",strokeMiterlimit:"10",strokeWidth:"32",d:"M87.49 380c1.19-4.38-1.44-10.47-3.95-14.86a44.86 44.86 0 0 0-2.54-3.8 199.81 199.81 0 0 1-33-110C47.65 139.09 140.73 48 255.83 48 356.21 48 440 117.54 459.58 209.85a199 199 0 0 1 4.42 41.64c0 112.41-89.49 204.93-204.59 204.93-18.3 0-43-4.6-56.47-8.37s-26.92-8.77-30.39-10.11a31.09 31.09 0 0 0-11.12-2.07 30.71 30.71 0 0 0-12.09 2.43l-67.83 24.48a16 16 0 0 1-4.67 1.22 9.6 9.6 0 0 1-9.57-9.74 15.85 15.85 0 0 1 .6-3.29z"},child:[]}]})(t)}function ee(t){const{data:o,isPending:i,isError:l}=C(B(t.comment.commentId)),{mutate:a}=O(),{mutate:m}=L(),{user:s}=b(),p=N();function x(n,r,g,h){n.preventDefault(),n.stopPropagation();const f=o&&o.find(I=>s&&I.userId===s.userId);s&&f?m({voteId:f.voteId,value:h}):s?a({userId:s&&s.userId||"",postId:r.postId,commentId:g.commentId,value:h}):p({to:"/login"})}return e.jsx("div",{children:l?e.jsx("div",{children:"Error fetching votes"}):i?e.jsx("div",{children:"Loading..."}):e.jsxs("div",{className:"flex w-fit rounded-full py-1 justify-center",children:[o.filter(n=>s&&n.userId===s.userId&&n.value===1).length>0?e.jsx("div",{onClick:n=>{n.stopPropagation(),n.preventDefault(),m({voteId:o.find(r=>r.postId===t.post.postId&&s&&r.userId===s.userId&&r.value===1).voteId,value:0})},className:"pr-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(U,{size:20})}):e.jsx("div",{onClick:n=>{x(n,t.post,t.comment,1)},className:"pr-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx($,{size:20})}),e.jsx("div",{className:"",children:o.filter(n=>n.postId===t.post.postId).reduce((n,r)=>n+r.value,0)}),o.filter(n=>s&&n.userId===s.userId&&n.value===-1).length>0?e.jsx("div",{onClick:n=>{n.stopPropagation(),n.preventDefault(),m({voteId:o.find(r=>r.postId===t.post.postId&&s&&r.userId===s.userId&&r.value===-1).voteId,value:0})},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(G,{size:20})}):e.jsx("div",{onClick:n=>{x(n,t.post,t.comment,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(K,{size:20})})]})})}function M(t){const[o,i]=j.useState(!1),{user:l}=b(),[a,m]=j.useState(""),{mutate:s}=E(),p=N();function x(n){if(n.preventDefault(),!l)return p({to:"/login"});const r=l.userId;s({userId:r,postId:t.post.postId,parentCommentId:t.comment.commentId,level:t.comment.level+1,content:a},{onSuccess:()=>m("")})}return e.jsxs("div",{className:"my-3",style:{paddingLeft:t.comment.level*25},children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[e.jsx("div",{className:"font-bold",children:t.comment.username}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:A(t.post.createdAt)})]}),e.jsx("div",{children:t.comment.content}),e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"mr-3",children:e.jsx(ee,{post:t.post,comment:t.comment})}),e.jsxs("div",{onClick:()=>i(!0),className:"flex ml-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:[e.jsx(_,{size:22}),e.jsx("div",{className:"ml-2",children:"Reply"})]})]}),o&&e.jsxs("form",{onSubmit:x,className:`pl-5 py-2 my-5 ${o?"rounded-2xl":"rounded-full"} border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300`,children:[e.jsx("input",{type:"text",placeholder:"Add your reply",className:"outline-none",value:a,onChange:n=>m(n.target.value),required:!0}),e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:n=>{n.stopPropagation(),i(!1)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{className:"mx-2 px-2 py-1 rounded-full bg-red-500",children:"Comment"})]})]}),t.comment.children?.map(n=>e.jsx(M,{comment:n,post:t.post},n.commentId))]},t.comment.commentId)}function se(){const t=T.useRouteContext(),{user:o}=b(),{data:i,isPending:l,error:a}=C(Z(t.postId)),{data:m,isPending:s,error:p}=C(J(t.userId)),[x,n]=j.useState(""),{mutate:r}=E(),g=N(),[h,f]=j.useState(!1),I=D(i&&i||[]);function D(c,w){const y=new Map;for(const d of c)y.set(d.commentId,{...d,children:[]});const v=[];for(const d of c){const u=y.get(d.commentId);if(d.parentCommentId==null){v.push(u);continue}const S=y.get(d.parentCommentId);if(!S){v.push(u);continue}S.children.push(u)}const V=(d,u)=>d.createdAt.getTime()-u.createdAt.getTime();function P(d){d.sort(V);for(const u of d)u.children.length&&P(u.children)}return P(v),v}function F(c){if(c.preventDefault(),!o)return g({to:"/login"});const w=o.userId;r({userId:w,postId:t.postId,content:x},{onSuccess:()=>n("")})}return e.jsxs("div",{className:"p-20 mx-auto w-full lg:w-[50%]",children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[s?e.jsx("div",{children:"Loading..."}):p?e.jsx("div",{children:"Error loading author"}):e.jsx("div",{className:"font-bold",children:m.username}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:A(t.createdAt)})]}),e.jsxs("div",{className:"text-4xl font-bold",children:[" ",t.title]}),e.jsx("div",{className:"my-10",children:e.jsx("div",{children:t.content})}),e.jsx(W,{post:t}),e.jsxs("form",{onClick:()=>f(!0),onSubmit:F,className:`pl-5 py-2 my-5 ${h?"rounded-2xl":"rounded-full"} border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300`,children:[e.jsx("input",{type:"text",placeholder:"Join the conversation",value:x,onChange:c=>n(c.target.value),required:!0,className:"outline-none"}),h&&e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:c=>{c.stopPropagation(),f(!1)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{className:"mx-2 px-2 py-1 rounded-full bg-red-500",children:"Comment"})]})]}),a?e.jsx("div",{}):l?e.jsx("div",{}):I.map(c=>e.jsx(M,{comment:c,post:t},c.commentId))]})}export{se as component};
