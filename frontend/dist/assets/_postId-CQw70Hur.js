import{q as H,d as T,e as L,f as E,u as I,a as b,j as e,r as f,F as X,h as Y,I as Z,R as ee,c as te,i as se,k as ne}from"./index-CKRTJe70.js";import{u as P,g as oe,a as re,b as ae,c as ie,e as le,f as de,h as ce,i as V,j as ue,d as O,F as Q,M as me,V as fe}from"./Menu-BsKjycAa.js";import{g as xe}from"./users-BjTP9myy.js";function pe(t){return{...t,createdAt:new Date(t.createdAt)}}async function he(t){const s=await E.api.v0.comments.$post({json:t});if(!s.ok){let l="There was an issue creating your comment :( We'll look into it ASAP!";try{const d=await s.json();d&&typeof d=="object"&&"message"in d&&(l=String(d.message))}catch(d){console.error("Failed to parse error response:",d)}throw new Error(l)}return await s.json()}const B=t=>{const s=T();return L({mutationFn:he,onSettled:()=>{s.invalidateQueries({queryKey:["comments"]})},onError:r=>{}})};async function ve(t){const s=await E.api.v0.comments[":postId"].$get({param:{postId:t.toString()}});if(!s.ok)throw new Error("Error getting comments by id");const{comments:r}=await s.json();return r.map(pe)}const je=t=>H({queryKey:["comments",t],queryFn:()=>ve(t)});async function ge(t){const s=await E.api.v0.comments.comment.delete.$post({json:t});if(!s.ok){let l="There was an issue deleting your post :( We'll look into it ASAP!";throw console.log(t),new Error(l)}return await s.json()}const ye=t=>{const s=T();return L({mutationFn:ge,onSettled:(r,l)=>{if(!r)return console.log("No data, returning");s.invalidateQueries({queryKey:["comments",r.commentResult.postId]}),s.invalidateQueries({queryKey:["posts"]})},onError:r=>{}})};function Ce(t){const{data:s,isPending:r,isError:l}=P(oe(t.comment.commentId)),{mutate:d}=re(),{mutate:u}=ae(),{user:i}=I(),g=b();function x(n,c,p,j){n.preventDefault(),n.stopPropagation();const h=s&&s.find(a=>i&&a.userId===i.userId);i&&h?u({voteId:h.voteId,value:j}):i?d({userId:i&&i.userId||"",postId:c.postId,commentId:p.commentId,value:j}):g({to:"/login"})}return e.jsx("div",{children:l?e.jsx("div",{children:"Error fetching votes"}):r?e.jsx("div",{children:"Loading..."}):e.jsxs("div",{className:"flex w-fit rounded-full py-1 justify-center",children:[s.filter(n=>i&&n.userId===i.userId&&n.value===1).length>0?e.jsx("div",{onClick:n=>{n.stopPropagation(),n.preventDefault(),u({voteId:s.find(c=>c.postId===t.post.postId&&i&&c.userId===i.userId&&c.value===1).voteId,value:0})},className:"pr-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(ie,{size:20})}):e.jsx("div",{onClick:n=>{x(n,t.post,t.comment,1)},className:"pr-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(le,{size:20})}),e.jsx("div",{className:"",children:s.filter(n=>n.postId===t.post.postId).reduce((n,c)=>n+c.value,0)}),s.filter(n=>i&&n.userId===i.userId&&n.value===-1).length>0?e.jsx("div",{onClick:n=>{n.stopPropagation(),n.preventDefault(),u({voteId:s.find(c=>c.postId===t.post.postId&&i&&c.userId===i.userId&&c.value===-1).voteId,value:0})},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(de,{size:20})}):e.jsx("div",{onClick:n=>{x(n,t.post,t.comment,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(ce,{size:20})})]})})}function Ie(t){const s=f.useRef(null),{user:r}=I(),{setEditCommentModePointer:l}=V();b();function d(u){s.current&&!s.current.contains(u.target)&&t.setShowMenu(!1)}return f.useEffect(()=>(document.addEventListener("click",d),()=>document.removeEventListener("click",d)),[]),e.jsxs("div",{ref:s,className:"absolute top-12 right-2 py-2 px-5 rounded bg-[#222222] shadow-[0_0_15px_rgba(0,0,0,0.7)] z-40",children:[r&&t.comment.userId===r.userId&&e.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[e.jsx(ue,{size:20,className:"pt-1"}),e.jsx("div",{onClick:()=>{l(t.comment.commentId),t.setShowMenu(!1)},className:"ml-2",children:"Edit"})]}),e.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[e.jsx(X,{size:20,className:"pt-1"}),e.jsx("div",{className:"ml-2",children:"Save"})]}),r&&t.comment.userId===r.userId&&e.jsxs("div",{onClick:u=>{u.stopPropagation(),u.preventDefault(),t.setDeleteMode(!0),t.setShowMenu(!1)},className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[e.jsx(Y,{size:20,className:"pt-1 "}),e.jsx("div",{className:"ml-2",children:"Delete"})]})]})}function U(t){const[s,r]=f.useState(!1),{user:l}=I(),[d,u]=f.useState(""),{mutate:i}=B(),g=b(),[x,n]=f.useState(!1),[c,p]=f.useState(!1),{mutate:j}=ye();function h(a){if(a.preventDefault(),!l)return g({to:"/login"});const y=l.userId;i({userId:y,postId:t.post.postId,parentCommentId:t.comment.commentId,level:t.comment.level+1,content:d},{onSuccess:()=>{u(""),r(!1)}})}return e.jsxs("div",{className:"my-3",style:{paddingLeft:window.innerWidth>760?t.comment.level*25:t.comment.level*10},children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[e.jsx("div",{className:"font-bold",children:t.comment.username}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:O(t.post.createdAt)})]}),e.jsx("div",{children:t.comment.content}),e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"mr-3",children:e.jsx(Ce,{post:t.post,comment:t.comment})}),e.jsxs("div",{onClick:()=>{l||g({to:"/login"}),r(!0)},className:"flex ml-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:[e.jsx(Z,{size:22}),e.jsx("div",{className:"ml-2",children:"Reply"})]}),l&&t.comment.userId===l.userId&&e.jsxs("div",{className:"relative",children:[e.jsx("div",{onClick:a=>{a.preventDefault(),a.stopPropagation(),n(!x)},className:"ml-3 px-2 pt-1.5 rounded-full hover:text-cyan-700 transition-all ease-in-out duration-300 cursor-pointer",children:e.jsx(Q,{})}),x&&e.jsx(Ie,{comment:t.comment,setDeleteMode:p,setShowMenu:n})]})]}),s&&e.jsxs("form",{onSubmit:h,className:`pl-5 py-2 my-5 ${s?"rounded-2xl":"rounded-full"} border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300`,children:[e.jsx("input",{type:"text",placeholder:"Add your reply",className:"outline-none",value:d,onChange:a=>u(a.target.value),required:!0}),e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:a=>{a.stopPropagation(),r(!1)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{className:"mx-2 px-2 py-1 rounded-full bg-red-500",children:"Comment"})]})]}),c&&e.jsxs("div",{className:"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-[#222222] p-6 rounded shadow-lg w-[90%] max-w-md text-center z-100",children:[e.jsx("div",{className:"text-2xl font-bold",children:"Delete Comment?"}),e.jsx("div",{className:"my-5",children:"Once you delete this comment, it can’t be restored."}),e.jsxs("div",{className:"my-5 flex justify-end",children:[e.jsx("div",{onClick:a=>{a.stopPropagation(),a.preventDefault(),j({commentId:t.comment.commentId}),p(!1)},className:"p-2 mr-1 bg-red-500 rounded text-white bold secondary-font font-bold cursor-pointer",children:"DELETE"}),e.jsx("div",{onClick:a=>{a.stopPropagation(),a.preventDefault(),p(!1)},className:"p-2 ml-1 bg-[#5c5c5c] rounded bold secondary-font font-bold cursor-pointer",children:"CANCEL"})]})]}),c&&e.jsx("div",{className:"fixed inset-0 bg-black opacity-50 z-60"}),t.comment.children?.map(a=>e.jsx(U,{comment:a,post:t.post},a.commentId))]},t.comment.commentId)}function Pe(){const t=ee.useRouteContext(),{user:s}=I(),{data:r,isPending:l,error:d}=P(je(t.postId)),{data:u,isPending:i,error:g}=P(xe(t.userId)),[x,n]=f.useState(""),{mutate:c}=B(),p=b(),[j,h]=f.useState(!1),a=_(r&&r||[]),[y,M]=f.useState(!1),[S,N]=f.useState(!1),{mutate:$}=te(),{editPostModePointer:K,setEditPostModePointer:k}=V(),{mutate:W}=se(),[D,A]=f.useState(t.content),F=ne();function _(o,R){const w=new Map;for(const m of o)w.set(m.commentId,{...m,children:[]});const C=[];for(const m of o){const v=w.get(m.commentId);if(m.parentCommentId==null){C.push(v);continue}const q=w.get(m.parentCommentId);if(!q){C.push(v);continue}q.children.push(v)}const G=(m,v)=>m.createdAt.getTime()-v.createdAt.getTime();function z(m){m.sort(G);for(const v of m)v.children.length&&z(v.children)}return z(C),C}function J(o){if(o.preventDefault(),!s)return p({to:"/login"});const R=s.userId;c({userId:R,postId:t.postId,content:x},{onSuccess:()=>{n(""),h(!1)}})}return e.jsxs("div",{className:"p-20 mx-auto w-full lg:w-[50%]",children:[e.jsxs("div",{className:"relative flex justify-between",children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[i?e.jsx("div",{children:"Loading..."}):g?e.jsx("div",{children:"Error loading author"}):e.jsx("div",{className:"font-bold",children:u.username}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:O(t.createdAt)})]}),e.jsx("div",{className:"",children:e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),M(!y)},className:" absolute top-1 right-1 p-3 rounded-full hover:bg-[#575757] transition-all ease-in-out duration-300",children:e.jsx(Q,{})})}),y&&e.jsx(me,{post:t,setDeleteMode:N,setShowMenu:M})]}),e.jsxs("div",{className:"text-4xl font-bold",children:[" ",t.title]}),K===t.postId?e.jsxs("div",{children:[e.jsx("textarea",{name:"content",id:"content",required:!0,className:"p-2 border border-[#c4c4c4] rounded my-2 w-full h-[300px]",placeholder:"content",value:D,onChange:o=>A(o.target.value)}),e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:o=>{o.stopPropagation(),k(0)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{onClick:()=>{W({postId:t.postId,content:D},{onSuccess:()=>{F.invalidate(),k(0)}})},className:"mx-2 px-2 py-1 rounded-full bg-cyan-700",children:"Save"})]})]}):e.jsx("div",{className:"my-10",children:e.jsx("div",{children:t.content})}),e.jsx(fe,{post:t}),e.jsxs("form",{onClick:()=>{s||p({to:"/login"}),h(!0)},onSubmit:J,className:`pl-5 py-2 my-5 ${j?"rounded-2xl":"rounded-full"} border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300`,children:[e.jsx("input",{type:"text",placeholder:"Join the conversation",value:x,onChange:o=>n(o.target.value),required:!0,className:"outline-none"}),s&&t.userId===s.userId&&S&&e.jsxs("div",{className:"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-[#222222] p-6 rounded shadow-lg w-[90%] max-w-md text-center z-100",children:[e.jsx("div",{className:"text-2xl font-bold",children:"Delete Post?"}),e.jsx("div",{className:"my-5",children:"Once you delete this post, it can’t be restored."}),e.jsxs("div",{className:"my-5 flex justify-end",children:[e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),$({postId:t.postId},{onSuccess:()=>{F.invalidate(),N(!1),A("[This post has been deleted by the user]")}})},className:"p-2 mr-1 bg-red-500 rounded text-white bold secondary-font font-bold cursor-pointer",children:"DELETE"}),e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),N(!1)},className:"p-2 ml-1 bg-[#5c5c5c] rounded bold secondary-font font-bold cursor-pointer",children:"CANCEL"})]})]}),s&&t.userId===s.userId&&S&&e.jsx("div",{className:"fixed inset-0 bg-black opacity-50 z-60"}),j&&e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:o=>{o.stopPropagation(),h(!1)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{className:"mx-2 px-2 py-1 rounded-full bg-red-500",children:"Comment"})]})]}),d?e.jsx("div",{}):l?e.jsx("div",{}):a.map(o=>e.jsx(U,{comment:o,post:t},o.commentId))]})}export{Pe as component};
