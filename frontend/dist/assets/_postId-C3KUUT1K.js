import{q as K,d as J,e as H,f as V,G as X,u as N,a as w,j as e,r as p,R as Y,c as Z,h as _,i as ee}from"./index-DGz1qFPC.js";import{u as b,g as te,a as ne,b as se,P as oe,c as re,e as ae,f as ie,d as z,F as T,h as de,M as ce,V as le}from"./Menu-DD2Qrm96.js";import{g as ue}from"./users-Dp26SqOv.js";function me(t){return{...t,createdAt:new Date(t.createdAt)}}async function xe(t){const s=await V.api.v0.comments.$post({json:t});if(!s.ok){let l="There was an issue creating your comment :( We'll look into it ASAP!";try{const i=await s.json();i&&typeof i=="object"&&"message"in i&&(l=String(i.message))}catch(i){console.error("Failed to parse error response:",i)}throw new Error(l)}return await s.json()}const L=t=>{const s=J();return H({mutationFn:xe,onSettled:()=>{s.invalidateQueries({queryKey:["comments"]})},onError:c=>{}})};async function pe(t){const s=await V.api.v0.comments[":postId"].$get({param:{postId:t.toString()}});if(!s.ok)throw new Error("Error getting comments by id");const{comments:c}=await s.json();return c.map(me)}const he=t=>K({queryKey:["comments",t],queryFn:()=>pe(t)});function fe(t){return X({attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{fill:"none",strokeLinecap:"round",strokeMiterlimit:"10",strokeWidth:"32",d:"M87.49 380c1.19-4.38-1.44-10.47-3.95-14.86a44.86 44.86 0 0 0-2.54-3.8 199.81 199.81 0 0 1-33-110C47.65 139.09 140.73 48 255.83 48 356.21 48 440 117.54 459.58 209.85a199 199 0 0 1 4.42 41.64c0 112.41-89.49 204.93-204.59 204.93-18.3 0-43-4.6-56.47-8.37s-26.92-8.77-30.39-10.11a31.09 31.09 0 0 0-11.12-2.07 30.71 30.71 0 0 0-12.09 2.43l-67.83 24.48a16 16 0 0 1-4.67 1.22 9.6 9.6 0 0 1-9.57-9.74 15.85 15.85 0 0 1 .6-3.29z"},child:[]}]})(t)}function ve(t){const{data:s,isPending:c,isError:l}=b(te(t.comment.commentId)),{mutate:i}=ne(),{mutate:m}=se(),{user:r}=N(),v=w();function f(n,a,d,h){n.preventDefault(),n.stopPropagation();const j=s&&s.find(y=>r&&y.userId===r.userId);r&&j?m({voteId:j.voteId,value:h}):r?i({userId:r&&r.userId||"",postId:a.postId,commentId:d.commentId,value:h}):v({to:"/login"})}return e.jsx("div",{children:l?e.jsx("div",{children:"Error fetching votes"}):c?e.jsx("div",{children:"Loading..."}):e.jsxs("div",{className:"flex w-fit rounded-full py-1 justify-center",children:[s.filter(n=>r&&n.userId===r.userId&&n.value===1).length>0?e.jsx("div",{onClick:n=>{n.stopPropagation(),n.preventDefault(),m({voteId:s.find(a=>a.postId===t.post.postId&&r&&a.userId===r.userId&&a.value===1).voteId,value:0})},className:"pr-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(oe,{size:20})}):e.jsx("div",{onClick:n=>{f(n,t.post,t.comment,1)},className:"pr-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(re,{size:20})}),e.jsx("div",{className:"",children:s.filter(n=>n.postId===t.post.postId).reduce((n,a)=>n+a.value,0)}),s.filter(n=>r&&n.userId===r.userId&&n.value===-1).length>0?e.jsx("div",{onClick:n=>{n.stopPropagation(),n.preventDefault(),m({voteId:s.find(a=>a.postId===t.post.postId&&r&&a.userId===r.userId&&a.value===-1).voteId,value:0})},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(ae,{size:20})}):e.jsx("div",{onClick:n=>{f(n,t.post,t.comment,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(ie,{size:20})})]})})}function O(t){const[s,c]=p.useState(!1),{user:l}=N(),[i,m]=p.useState(""),{mutate:r}=L(),v=w(),[f,n]=p.useState(!1);function a(d){if(d.preventDefault(),!l)return v({to:"/login"});const h=l.userId;r({userId:h,postId:t.post.postId,parentCommentId:t.comment.commentId,level:t.comment.level+1,content:i},{onSuccess:()=>m("")})}return e.jsxs("div",{className:"my-3",style:{paddingLeft:window.innerWidth>760?t.comment.level*25:t.comment.level*10},children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[e.jsx("div",{className:"font-bold",children:t.comment.username}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:z(t.post.createdAt)})]}),e.jsx("div",{children:t.comment.content}),e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"mr-3",children:e.jsx(ve,{post:t.post,comment:t.comment})}),e.jsxs("div",{onClick:()=>c(!0),className:"flex ml-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:[e.jsx(fe,{size:22}),e.jsx("div",{className:"ml-2",children:"Reply"})]}),l&&t.comment.userId===l.userId&&e.jsx("div",{onClick:d=>{n(!0)},className:"ml-3 px-2 pt-1.5 rounded-full hover:text-cyan-700 transition-all ease-in-out duration-300 cursor-pointer",children:e.jsx(T,{})})]}),s&&e.jsxs("form",{onSubmit:a,className:`pl-5 py-2 my-5 ${s?"rounded-2xl":"rounded-full"} border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300`,children:[e.jsx("input",{type:"text",placeholder:"Add your reply",className:"outline-none",value:i,onChange:d=>m(d.target.value),required:!0}),e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:d=>{d.stopPropagation(),c(!1)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{className:"mx-2 px-2 py-1 rounded-full bg-red-500",children:"Comment"})]})]}),t.comment.children?.map(d=>e.jsx(O,{comment:d,post:t.post},d.commentId))]},t.comment.commentId)}function Ie(){const t=Y.useRouteContext(),{user:s}=N(),{data:c,isPending:l,error:i}=b(he(t.postId)),{data:m,isPending:r,error:v}=b(ue(t.userId)),[f,n]=p.useState(""),{mutate:a}=L(),d=w(),[h,j]=p.useState(!1),y=$(c&&c||[]),[P,S]=p.useState(!1),[M,I]=p.useState(!1),{mutate:Q}=Z(),{editModePointer:B,setEditModePointer:k}=de(),{mutate:U}=_(),[E,D]=p.useState(t.content),A=ee();function $(o,F){const C=new Map;for(const u of o)C.set(u.commentId,{...u,children:[]});const g=[];for(const u of o){const x=C.get(u.commentId);if(u.parentCommentId==null){g.push(x);continue}const R=C.get(u.parentCommentId);if(!R){g.push(x);continue}R.children.push(x)}const G=(u,x)=>u.createdAt.getTime()-x.createdAt.getTime();function q(u){u.sort(G);for(const x of u)x.children.length&&q(x.children)}return q(g),g}function W(o){if(o.preventDefault(),!s)return d({to:"/login"});const F=s.userId;a({userId:F,postId:t.postId,content:f},{onSuccess:()=>n("")})}return e.jsxs("div",{className:"p-20 mx-auto w-full lg:w-[50%]",children:[e.jsxs("div",{className:"relative flex justify-between",children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[r?e.jsx("div",{children:"Loading..."}):v?e.jsx("div",{children:"Error loading author"}):e.jsx("div",{className:"font-bold",children:m.username}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:z(t.createdAt)})]}),e.jsx("div",{className:"",children:e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),S(!P)},className:" absolute top-1 right-1 p-3 rounded-full hover:bg-[#575757] transition-all ease-in-out duration-300",children:e.jsx(T,{})})}),P&&e.jsx(ce,{post:t,setDeleteMode:I,setShowMenu:S})]}),e.jsxs("div",{className:"text-4xl font-bold",children:[" ",t.title]}),B===t.postId?e.jsxs("div",{children:[e.jsx("textarea",{name:"content",id:"content",required:!0,className:"p-2 border border-[#c4c4c4] rounded my-2 w-full h-[300px]",placeholder:"content",value:E,onChange:o=>D(o.target.value)}),e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:o=>{o.stopPropagation(),k(0)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{onClick:()=>{U({postId:t.postId,content:E},{onSuccess:()=>{A.invalidate(),k(0)}})},className:"mx-2 px-2 py-1 rounded-full bg-cyan-700",children:"Save"})]})]}):e.jsx("div",{className:"my-10",children:e.jsx("div",{children:t.content})}),e.jsx(le,{post:t}),e.jsxs("form",{onClick:()=>j(!0),onSubmit:W,className:`pl-5 py-2 my-5 ${h?"rounded-2xl":"rounded-full"} border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300`,children:[e.jsx("input",{type:"text",placeholder:"Join the conversation",value:f,onChange:o=>n(o.target.value),required:!0,className:"outline-none"}),s&&t.userId===s.userId&&M&&e.jsxs("div",{className:"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-[#222222] p-6 rounded shadow-lg w-[90%] max-w-md text-center z-100",children:[e.jsx("div",{className:"text-2xl font-bold",children:"Delete Post?"}),e.jsx("div",{className:"my-5",children:"Once you delete this post, it can’t be restored."}),e.jsxs("div",{className:"my-5 flex justify-end",children:[e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),Q({postId:t.postId},{onSuccess:()=>{A.invalidate(),I(!1),D("[This post has been deleted by the user]")}})},className:"p-2 mr-1 bg-red-500 rounded text-white bold secondary-font font-bold cursor-pointer",children:"DELETE"}),e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),I(!1)},className:"p-2 ml-1 bg-[#5c5c5c] rounded bold secondary-font font-bold cursor-pointer",children:"CANCEL"})]})]}),s&&t.userId===s.userId&&M&&e.jsx("div",{className:"fixed inset-0 bg-black opacity-50 z-60"}),h&&e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:o=>{o.stopPropagation(),j(!1)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{className:"mx-2 px-2 py-1 rounded-full bg-red-500",children:"Comment"})]})]}),i?e.jsx("div",{}):l?e.jsx("div",{}):y.map(o=>e.jsx(O,{comment:o,post:t},o.commentId))]})}export{Ie as component};
