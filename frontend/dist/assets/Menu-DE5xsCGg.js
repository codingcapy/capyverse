import{S as v,T as c,U as w,V as x,W as q,u as F,a as M,b as E,j as s,X as V,r as C,m as B,Y as A,c as Q,Z as z,_ as $,F as K,C as b}from"./index-BAe1x1pE.js";import{o as U,p as k,q as L,r as j}from"./images-C0P_LJxD.js";function S(e){return{...e,createdAt:new Date(e.createdAt)}}const g=q();async function D(e){const t=await c.api.v0.comments.$post({json:e},g?{headers:{Authorization:`Bearer ${g}`}}:void 0);if(!t.ok){let n="There was an issue creating your comment :( We'll look into it ASAP!";try{const r=await t.json();r&&typeof r=="object"&&"message"in r&&(n=String(r.message))}catch(r){console.error("Failed to parse error response:",r)}throw new Error(n)}return await t.json()}const ue=e=>{const t=w();return x({mutationFn:D,onSettled:()=>{t.invalidateQueries({queryKey:["comments"]})},onError:o=>{}})};async function R(e){const t=await c.api.v0.comments[":postId"].$get({param:{postId:e.toString()}});if(!t.ok)throw new Error("Error getting comments by id");const{comments:o}=await t.json();return o.map(S)}const ce=e=>v({queryKey:["comments",e],queryFn:()=>R(e)});async function O(e){const t=await c.api.v0.comments.comment.delete.$post({json:e},g?{headers:{Authorization:`Bearer ${g}`}}:void 0);if(!t.ok){let n="There was an issue deleting your post :( We'll look into it ASAP!";throw console.log(e),new Error(n)}return await t.json()}const de=e=>{const t=w();return x({mutationFn:O,onSettled:(o,n)=>{if(!o)return console.log("No data, returning");t.invalidateQueries({queryKey:["comments",o.commentResult.postId]}),t.invalidateQueries({queryKey:["posts"]})},onError:o=>{}})};async function T(e){const t=await c.api.v0.comments.comment.update.$post({json:e},g?{headers:{Authorization:`Bearer ${g}`}}:void 0);if(!t.ok){let n="There was an issue updating your post :( We'll look into it ASAP!";throw console.log(e),new Error(n)}return await t.json()}const me=e=>{const t=w();return x({mutationFn:T,onSettled:(o,n)=>{if(!o)return console.log("No data, returning");t.invalidateQueries({queryKey:["comments",o.commentResult.postId]}),t.invalidateQueries({queryKey:["posts"]})},onError:o=>{}})};async function W(e){const t=await c.api.v0.comments.user[":userId"].$get({param:{userId:e.toString()}});if(!t.ok)throw new Error("Error getting comments by user id");const{comments:o}=await t.json();return o.map(S)}const le=e=>v({queryKey:["comments",e],queryFn:()=>W(e)});async function _(e){const t=await c.api.v0.comments.post.count[":postId"].$get({param:{postId:e.toString()}});if(!t.ok)throw new Error("Error getting comments by id");const{commentsLength:o}=await t.json();return o}const ye=e=>v({queryKey:["comments-length",e],queryFn:()=>_(e)});async function Z(e){const t=await c.api.v0.comments.user.comments[":username"].$get({param:{username:e.toString()}});if(!t.ok)throw new Error("Error getting comments by username");const{comments:o}=await t.json();return o.map(S)}const ve=e=>v({queryKey:["user-comments",e],queryFn:()=>Z(e)}),I=q();async function G(e){const t=await c.api.v0.votes.$post({json:e},I?{headers:{Authorization:`Bearer ${I}`}}:void 0);if(!t.ok){let n="There was an issue creating your vote :( We'll look into it ASAP!";try{const r=await t.json();r&&typeof r=="object"&&"message"in r&&(n=String(r.message))}catch(r){console.error("Failed to parse error response:",r)}throw new Error(n)}const o=await t.json();if(!o.vote)throw new Error("Invalid response from server");return o.vote}const X=e=>{const t=w();return x({mutationFn:G,onSuccess:o=>{t.invalidateQueries({queryKey:["user-vote",o.postId,o.userId]}),t.invalidateQueries({queryKey:["votes-summary",o.postId]}),t.invalidateQueries({queryKey:["comment-votes",o.commentId]})},onError:o=>{}})};async function Y(e){const t=await c.api.v0.votes[":postId"].$get({param:{postId:e.toString()}});if(!t.ok)throw new Error("Error getting votes by postId");const{votes:o}=await t.json();return o}const pe=e=>v({queryKey:["post-votes",e],queryFn:()=>Y(e)});async function H(e){const t=await c.api.v0.votes.update.$post({json:e},I?{headers:{Authorization:`Bearer ${I}`}}:void 0);if(!t.ok){let n="There was an issue updating your vote :( We'll look into it ASAP!";throw console.log(e),new Error(n)}const{vote:o}=await t.json();return o}const J=e=>{const t=w();return x({mutationFn:H,onSuccess:o=>{t.invalidateQueries({queryKey:["comment-votes",o.commentId]}),t.invalidateQueries({queryKey:["user-vote",o.postId,o.userId]}),t.invalidateQueries({queryKey:["votes-summary",o.postId]})},onError:o=>{}})};async function ee(e){const t=await c.api.v0.votes.comments[":commentId"].$get({param:{commentId:e.toString()}});if(!t.ok)throw new Error("Error getting comment votes by commentId");const{votes:o}=await t.json();return o}const ge=e=>v({queryKey:["comment-votes",e],queryFn:()=>ee(e)});async function te(e){const t=await c.api.v0.votes.post.summary[":postId"].$get({param:{postId:e.toString()}});if(!t.ok)throw new Error("Error getting votes by postId");return await t.json()}const oe=e=>v({queryKey:["votes-summary",e],queryFn:()=>te(e)});async function se(e,t){const o=await c.api.v0.votes.post.user[":postId"][":userId"].$get({param:{postId:e.toString(),userId:t.toString()}});if(!o.ok)throw new Error("Error getting user vote by postId");return await o.json()}const re=(e,t)=>v({queryKey:["user-vote",e,t],queryFn:()=>se(e,t)});function fe(e){const{mutate:t,isPending:o}=X(),{mutate:n,isPending:r}=J(),{user:u}=F(),m=M(),{data:y,isLoading:p,error:f}=E(oe(e.post.postId)),{data:d,isLoading:h,error:i}=E(re(e.post.postId,u&&u.userId||""));function l(a,N,P){if(a.preventDefault(),a.stopPropagation(),!(o||r)){if(!u){m({to:"/login"});return}d&&d.voted?n({voteId:d.voteId,value:P}):u?t({userId:u&&u.userId||"",postId:N.postId,value:P}):m({to:"/login"})}}return s.jsx("div",{children:s.jsxs("div",{className:"flex bg-[#3e3e3e] w-fit rounded-full py-1 justify-center",children:[u?h?s.jsx(s.Fragment,{children:"Loading..."}):i?s.jsx(s.Fragment,{children:"Error loading user vote"}):d?d.value===1?s.jsx("div",{onClick:a=>{l(a,e.post,0)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:r?"Updating...":s.jsx(U,{size:20})}):s.jsx("div",{onClick:a=>{l(a,e.post,1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:s.jsx(k,{size:20})}):s.jsx("div",{onClick:a=>{l(a,e.post,1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:o?"Voting...":s.jsx(k,{size:20})}):s.jsx("div",{onClick:a=>{l(a,e.post,1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:o?"Voting...":s.jsx(k,{size:20})}),s.jsx("div",{className:"font-semibold",children:p?s.jsx("div",{children:"Loading..."}):f?s.jsx("div",{children:"Error loading votes"}):y?y.score:0}),u?h?s.jsx(s.Fragment,{children:"Loading..."}):i?s.jsx(s.Fragment,{children:"Error loading user vote"}):d?d.value===-1?s.jsx("div",{onClick:a=>{l(a,e.post,0)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:r?"Updating...":s.jsx(L,{size:20})}):d.value===0?s.jsx("div",{onClick:a=>{l(a,e.post,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:r?"Updating...":s.jsx(j,{size:20})}):s.jsx("div",{onClick:a=>{l(a,e.post,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:r?"Updating...":s.jsx(j,{size:20})}):s.jsx("div",{onClick:a=>{l(a,e.post,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:o?"Voting...":s.jsx(j,{size:20})}):s.jsx("div",{onClick:a=>{l(a,e.post,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:o?"Voting...":s.jsx(j,{size:20})})]})})}function he(e){const t=typeof e=="string"?new Date(e.replace(" ","T")+"Z"):e,o=Date.now();let n=Math.floor((o-t.getTime())/1e3);const r=new Intl.RelativeTimeFormat("en",{numeric:"auto"});if(n<60)return r.format(-n,"second");const u=Math.floor(n/60);if(u<60)return r.format(-u,"minute");const m=Math.floor(u/60);if(m<24)return r.format(-m,"hour");const y=Math.floor(m/24);if(y<30)return r.format(-y,"day");const p=Math.floor(y/30);if(p<12)return r.format(-p,"month");const f=Math.floor(p/12);return r.format(-f,"year")}function ne(e){return V({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"},child:[]}]})(e)}function we(e){const t=C.useRef(null),{user:o}=F(),{setEditPostModePointer:n}=B(),r=M(),{mutate:u,isPending:m}=A(),{data:y}=E(Q(o&&o.userId||"")),p=!!y?.some(i=>i.postId===e.post.postId),{mutate:f,isPending:d}=z();function h(i){t.current&&!t.current.contains(i.target)&&e.setShowMenu(!1)}return C.useEffect(()=>(document.addEventListener("click",h),()=>document.removeEventListener("click",h)),[]),s.jsxs("div",{ref:t,className:"absolute top-12 right-2 py-2 px-5 rounded bg-[#222222] shadow-[0_0_15px_rgba(0,0,0,0.7)] z-40",children:[o&&e.post.userId===o.userId&&s.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[s.jsx(ne,{size:20,className:"pt-1"}),s.jsx("div",{onClick:()=>{n(e.post.postId),r({to:`/posts/${e.post.postId}`}),e.setShowMenu(!1)},className:"ml-2",children:"Edit"})]}),p?s.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[s.jsx($,{size:20,className:"pt-1"}),s.jsx("div",{onClick:i=>{if(i.stopPropagation(),i.preventDefault(),!o)return r({to:"/login"});d||f({userId:o.userId||"",postId:e.post.postId},{onSuccess:()=>e.setShowMenu(!1)})},className:"ml-2",children:d?"Removing...":"Remove from saved"})]}):s.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[s.jsx(K,{size:20,className:"pt-1"}),s.jsx("div",{onClick:i=>{if(i.stopPropagation(),i.preventDefault(),!o)return r({to:"/login"});m||u({userId:o.userId||"",postId:e.post.postId},{onSuccess:()=>e.setShowMenu(!1)})},className:"ml-2",children:m?"Saving...":"Save"})]}),o&&e.post.userId===o.userId&&s.jsxs("div",{onClick:i=>{i.stopPropagation(),i.preventDefault(),e.setDeleteMode(!0),e.setShowMenu(!1)},className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[s.jsx(b,{size:20,className:"pt-1 "}),s.jsx("div",{className:"ml-2",children:"Delete"})]})]})}export{ne as F,we as M,fe as V,ye as a,pe as b,ve as c,he as d,ue as e,me as f,le as g,ce as h,ge as i,X as j,J as k,de as u};
