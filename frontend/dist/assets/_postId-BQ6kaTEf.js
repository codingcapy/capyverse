import{q as ee,e as q,f as R,h as S,u as M,a as k,j as e,r as f,d as z,F as te,i as ne,I as oe,R as se,c as re,k as ae,l as ie}from"./index-CzHZuhTX.js";import{u as E,a as le,b as de,c as ce,e as ue,f as me,h as fe,i as xe,j as pe,d as B,F as W,M as he,V as ve}from"./Menu-BpIz--aA.js";import{g as $}from"./users-BsQrLrRH.js";import{d as F}from"./capypaul01-dN7xfBcC.js";function je(t){return{...t,createdAt:new Date(t.createdAt)}}async function ge(t){const n=await S.api.v0.comments.$post({json:t});if(!n.ok){let i="There was an issue creating your comment :( We'll look into it ASAP!";try{const l=await n.json();l&&typeof l=="object"&&"message"in l&&(i=String(l.message))}catch(l){console.error("Failed to parse error response:",l)}throw new Error(i)}return await n.json()}const _=t=>{const n=q();return R({mutationFn:ge,onSettled:()=>{n.invalidateQueries({queryKey:["comments"]})},onError:s=>{}})};async function ye(t){const n=await S.api.v0.comments[":postId"].$get({param:{postId:t.toString()}});if(!n.ok)throw new Error("Error getting comments by id");const{comments:s}=await n.json();return s.map(je)}const Ce=t=>ee({queryKey:["comments",t],queryFn:()=>ye(t)});async function Ie(t){const n=await S.api.v0.comments.comment.delete.$post({json:t});if(!n.ok){let i="There was an issue deleting your post :( We'll look into it ASAP!";throw console.log(t),new Error(i)}return await n.json()}const be=t=>{const n=q();return R({mutationFn:Ie,onSettled:(s,i)=>{if(!s)return console.log("No data, returning");n.invalidateQueries({queryKey:["comments",s.commentResult.postId]}),n.invalidateQueries({queryKey:["posts"]})},onError:s=>{}})};async function Ne(t){const n=await S.api.v0.comments.comment.update.$post({json:t});if(!n.ok){let i="There was an issue updating your post :( We'll look into it ASAP!";throw console.log(t),new Error(i)}return await n.json()}const we=t=>{const n=q();return R({mutationFn:Ne,onSettled:(s,i)=>{if(!s)return console.log("No data, returning");n.invalidateQueries({queryKey:["comments",s.commentResult.postId]}),n.invalidateQueries({queryKey:["posts"]})},onError:s=>{}})};function Pe(t){const{data:n,isLoading:s,isError:i}=E(le(t.comment.commentId)),{mutate:l}=de(),{mutate:c}=ce(),{user:d}=M(),g=k();function x(o,u,j,p){o.preventDefault(),o.stopPropagation();const h=n&&n.find(y=>d&&y.userId===d.userId);d&&h?c({voteId:h.voteId,value:p}):d?l({userId:d&&d.userId||"",postId:u.postId,commentId:j.commentId,value:p}):g({to:"/login"})}return e.jsx("div",{children:i?e.jsx("div",{children:"Error fetching votes"}):s?e.jsx("div",{children:"Loading..."}):n?e.jsxs("div",{className:"flex w-fit rounded-full py-1 justify-center",children:[n.filter(o=>d&&o.userId===d.userId&&o.value===1).length>0?e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),c({voteId:n.find(u=>u.postId===t.post.postId&&d&&u.userId===d.userId&&u.value===1).voteId,value:0})},className:"pr-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(ue,{size:20})}):e.jsx("div",{onClick:o=>{x(o,t.post,t.comment,1)},className:"pr-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(me,{size:20})}),e.jsx("div",{className:"",children:n.filter(o=>o.postId===t.post.postId).reduce((o,u)=>o+u.value,0)}),n.filter(o=>d&&o.userId===d.userId&&o.value===-1).length>0?e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),c({voteId:n.find(u=>u.postId===t.post.postId&&d&&u.userId===d.userId&&u.value===-1).voteId,value:0})},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(fe,{size:20})}):e.jsx("div",{onClick:o=>{x(o,t.post,t.comment,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(xe,{size:20})})]}):e.jsx("div",{children:"An unexpected error has occured"})})}function Ee(t){const n=f.useRef(null),{user:s}=M(),{setEditCommentModePointer:i}=z();k();function l(c){n.current&&!n.current.contains(c.target)&&t.setShowMenu(!1)}return f.useEffect(()=>(document.addEventListener("click",l),()=>document.removeEventListener("click",l)),[]),e.jsxs("div",{ref:n,className:"absolute top-12 right-2 py-2 px-5 rounded bg-[#222222] shadow-[0_0_15px_rgba(0,0,0,0.7)] z-40",children:[s&&t.comment.userId===s.userId&&e.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[e.jsx(pe,{size:20,className:"pt-1"}),e.jsx("div",{onClick:()=>{i(t.comment.commentId),t.setCommentContent(t.comment.content||""),t.setShowMenu(!1)},className:"ml-2",children:"Edit"})]}),e.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[e.jsx(te,{size:20,className:"pt-1"}),e.jsx("div",{className:"ml-2",children:"Save"})]}),s&&t.comment.userId===s.userId&&e.jsxs("div",{onClick:c=>{c.stopPropagation(),c.preventDefault(),t.setDeleteMode(!0),t.setShowMenu(!1)},className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[e.jsx(ne,{size:20,className:"pt-1 "}),e.jsx("div",{className:"ml-2",children:"Delete"})]})]})}function J(t){const[n,s]=f.useState(!1),{user:i}=M(),[l,c]=f.useState(""),{mutate:d,isPending:g}=_(),x=k(),[o,u]=f.useState(!1),[j,p]=f.useState(!1),{mutate:h,isPending:y}=be(),{editCommentModePointer:b,setEditCommentModePointer:C}=z(),{mutate:N}=we();function I(r){if(r.preventDefault(),!i)return x({to:"/login"});const w=i.userId;d({userId:w,postId:t.post.postId,parentCommentId:t.comment.commentId,level:t.comment.level+1,content:l},{onSuccess:()=>{c(""),s(!1)}})}function D(r){if(r.preventDefault(),!i)return x({to:"/login"});N({commentId:t.comment.commentId,content:l},{onSuccess:()=>{C(0),c("")}})}return e.jsxs("div",{className:"my-3",style:{marginLeft:window.innerWidth>760?t.comment.level*25:t.comment.level*10},children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[e.jsx("div",{className:"font-bold",children:t.comment.username}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:B(t.post.createdAt)})]}),b===t.comment.commentId?e.jsxs("form",{onSubmit:D,className:"pl-5 py-2 my-5 rounded-2xl border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300",children:[e.jsx("input",{type:"text",placeholder:"Add your reply",className:"outline-none w-full",value:l,onChange:r=>c(r.target.value),required:!0}),e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:r=>{r.stopPropagation(),C(0)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{className:"mx-2 px-2 py-1 rounded-full bg-red-500 cursor-pointer",children:"Save Edits"})]})]}):e.jsx("div",{children:t.comment.content}),e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"mr-3",children:e.jsx(Pe,{post:t.post,comment:t.comment})}),e.jsxs("div",{onClick:()=>{i||x({to:"/login"}),s(!0)},className:"flex ml-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:[e.jsx(oe,{size:22}),e.jsx("div",{className:"ml-2",children:"Reply"})]}),i&&t.comment.userId===i.userId&&e.jsxs("div",{className:"relative",children:[e.jsx("div",{onClick:r=>{r.preventDefault(),r.stopPropagation(),u(!o)},className:"ml-3 px-2 pt-1.5 rounded-full hover:text-cyan-700 transition-all ease-in-out duration-300 cursor-pointer",children:e.jsx(W,{})}),o&&e.jsx(Ee,{comment:t.comment,setDeleteMode:p,setShowMenu:u,setCommentContent:c})]})]}),n&&e.jsxs("form",{onSubmit:I,className:`pl-5 py-2 my-5 ${n?"rounded-2xl":"rounded-full"} border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300`,children:[e.jsx("input",{type:"text",placeholder:"Add your reply",className:"outline-none w-full",value:l,onChange:r=>c(r.target.value),required:!0}),e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:r=>{r.stopPropagation(),s(!1)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{disabled:g,className:"mx-2 px-2 py-1 rounded-full bg-red-500 cursor-pointer",children:g?"Creating...":"Comment"})]})]}),j&&e.jsxs("div",{className:"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-[#222222] p-6 rounded shadow-lg w-[90%] max-w-md text-center z-100",children:[e.jsx("div",{className:"text-2xl font-bold",children:"Delete Comment?"}),e.jsx("div",{className:"my-5",children:"Once you delete this comment, it can’t be restored."}),e.jsxs("div",{className:"my-5 flex justify-end",children:[e.jsx("div",{onClick:r=>{r.stopPropagation(),r.preventDefault(),!y&&(h({commentId:t.comment.commentId}),p(!1))},className:"p-2 mr-1 bg-red-500 rounded text-white bold secondary-font font-bold cursor-pointer",children:y?"Deleting...":"DELETE"}),e.jsx("div",{onClick:r=>{r.stopPropagation(),r.preventDefault(),p(!1)},className:"p-2 ml-1 bg-[#5c5c5c] rounded bold secondary-font font-bold cursor-pointer",children:"CANCEL"})]})]}),j&&e.jsx("div",{className:"fixed inset-0 bg-black opacity-50 z-90"}),t.comment.children?.map(r=>e.jsx(J,{comment:r,post:t.post},r.commentId))]},t.comment.commentId)}function Ae(){const t=se.useRouteContext(),{user:n}=M(),{data:s,isLoading:i,error:l}=E(Ce(t.postId)),{data:c,isLoading:d,error:g}=E($(t.userId)),[x,o]=f.useState(""),{mutate:u}=_(),j=k(),[p,h]=f.useState(!1),y=X(s&&s||[]),[b,C]=f.useState(!1),[N,I]=f.useState(!1),{mutate:D}=re(),{editPostModePointer:r,setEditPostModePointer:w}=z(),{mutate:G}=ae(),[T,Q]=f.useState(t.content),V=ie(),{data:A,isLoading:H}=E($(t.userId));function X(a,O){const L=new Map;for(const m of a)L.set(m.commentId,{...m,children:[]});const P=[];for(const m of a){const v=L.get(m.commentId);if(m.parentCommentId==null){P.push(v);continue}const U=L.get(m.parentCommentId);if(!U){P.push(v);continue}U.children.push(v)}const Z=(m,v)=>m.createdAt.getTime()-v.createdAt.getTime();function K(m){m.sort(Z);for(const v of m)v.children.length&&K(v.children)}return K(P),P}function Y(a){if(a.preventDefault(),!n)return j({to:"/login"});const O=n.userId;u({userId:O,postId:t.postId,content:x},{onSuccess:()=>{o(""),h(!1)}})}return e.jsxs("div",{className:"pt-[70px] mx-auto w-full lg:w-[50%]",children:[e.jsxs("div",{className:"relative flex justify-between",children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[e.jsx("img",{src:H?F:A?A.profilePic?A.profilePic:F:F,alt:"",className:"w-8 h-8 rounded-full"}),d?e.jsx("div",{className:"ml-2",children:"Loading..."}):g?e.jsx("div",{children:"Error loading author"}):c?e.jsx("div",{className:"font-bold ml-2",children:c.username}):e.jsx("div",{className:"ml-2",children:"unknown author"}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:B(t.createdAt)})]}),e.jsx("div",{className:"",children:e.jsx("div",{onClick:a=>{a.stopPropagation(),a.preventDefault(),C(!b)},className:" absolute top-1 right-1 p-3 rounded-full hover:bg-[#575757] transition-all ease-in-out duration-300",children:e.jsx(W,{})})}),b&&e.jsx(he,{post:t,setDeleteMode:I,setShowMenu:C})]}),e.jsxs("div",{className:"text-4xl font-bold",children:[" ",t.title]}),r===t.postId?e.jsxs("div",{children:[e.jsx("textarea",{name:"content",id:"content",required:!0,className:"p-2 border border-[#c4c4c4] rounded my-2 w-full h-[300px]",placeholder:"content",value:T,onChange:a=>Q(a.target.value)}),e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:a=>{a.stopPropagation(),w(0)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{onClick:()=>{G({postId:t.postId,content:T},{onSuccess:()=>{V.invalidate(),w(0)}})},className:"mx-2 px-2 py-1 rounded-full bg-cyan-700",children:"Save"})]})]}):e.jsx("div",{className:"my-10",children:e.jsx("div",{children:t.content})}),e.jsx(ve,{post:t}),e.jsxs("form",{onClick:()=>{n||j({to:"/login"}),h(!0)},onSubmit:Y,className:`pl-5 py-2 my-5 ${p?"rounded-2xl":"rounded-full"} border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300`,children:[e.jsx("input",{type:"text",placeholder:"Join the conversation",value:x,onChange:a=>o(a.target.value),required:!0,className:"outline-none w-full"}),p&&e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:a=>{a.stopPropagation(),h(!1)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{className:"mx-2 px-2 py-1 rounded-full bg-red-500 cursor-pointer",children:"Comment"})]})]}),n&&t.userId===n.userId&&N&&e.jsxs("div",{className:"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-[#222222] p-6 rounded shadow-lg w-[90%] max-w-md text-center z-100",children:[e.jsx("div",{className:"text-2xl font-bold",children:"Delete Post?"}),e.jsx("div",{className:"my-5",children:"Once you delete this post, it can’t be restored."}),e.jsxs("div",{className:"my-5 flex justify-end",children:[e.jsx("div",{onClick:a=>{a.stopPropagation(),a.preventDefault(),D({postId:t.postId},{onSuccess:()=>{V.invalidate(),I(!1),Q("[This post has been deleted by the user]")}})},className:"p-2 mr-1 bg-red-500 rounded text-white bold secondary-font font-bold cursor-pointer",children:"DELETE"}),e.jsx("div",{onClick:a=>{a.stopPropagation(),a.preventDefault(),I(!1)},className:"p-2 ml-1 bg-[#5c5c5c] rounded bold secondary-font font-bold cursor-pointer",children:"CANCEL"})]})]}),n&&t.userId===n.userId&&N&&e.jsx("div",{className:"fixed inset-0 bg-black opacity-50 z-90"}),l?e.jsx("div",{children:"Error loading comments"}):i?e.jsx("div",{children:"Loading..."}):y.map(a=>e.jsx(J,{comment:a,post:t},a.commentId))]})}export{Ae as component};
