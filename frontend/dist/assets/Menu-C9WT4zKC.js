import{T as v,U as c,V as h,W as w,X as x,u as C,a as q,b as k,j as s,Y as M,r as P,m as N,Z as V,c as B,_ as A,$ as Q,F as z,D as $}from"./index-Clugc84n.js";import{f as K,h as I,i as b,j}from"./images-2pmZfYHy.js";function E(e){return{...e,createdAt:new Date(e.createdAt)}}async function U(e){const o=x(),t=await c.api.v0.comments.$post({json:e},o?{headers:{Authorization:`Bearer ${o}`}}:void 0);if(!t.ok){let r="There was an issue creating your comment :( We'll look into it ASAP!";try{const n=await t.json();n&&typeof n=="object"&&"message"in n&&(r=String(n.message))}catch(n){console.error("Failed to parse error response:",n)}throw new Error(r)}return await t.json()}const ae=e=>{const o=h();return w({mutationFn:U,onSettled:()=>{o.invalidateQueries({queryKey:["comments"]})},onError:t=>{}})};async function L(e){const o=await c.api.v0.comments[":postId"].$get({param:{postId:e.toString()}});if(!o.ok)throw new Error("Error getting comments by id");const{comments:t}=await o.json();return t.map(E)}const ie=e=>v({queryKey:["comments",e],queryFn:()=>L(e)});async function D(e){const o=x(),t=await c.api.v0.comments.comment.delete.$post({json:e},o?{headers:{Authorization:`Bearer ${o}`}}:void 0);if(!t.ok){let r="There was an issue deleting your post :( We'll look into it ASAP!";throw console.log(e),new Error(r)}return await t.json()}const ue=e=>{const o=h();return w({mutationFn:D,onSettled:(t,i)=>{if(!t)return console.log("No data, returning");o.invalidateQueries({queryKey:["comments",t.commentResult.postId]}),o.invalidateQueries({queryKey:["posts"]})},onError:t=>{}})};async function R(e){const o=x(),t=await c.api.v0.comments.comment.update.$post({json:e},o?{headers:{Authorization:`Bearer ${o}`}}:void 0);if(!t.ok){let r="There was an issue updating your post :( We'll look into it ASAP!";throw console.log(e),new Error(r)}return await t.json()}const ce=e=>{const o=h();return w({mutationFn:R,onSettled:(t,i)=>{if(!t)return console.log("No data, returning");o.invalidateQueries({queryKey:["comments",t.commentResult.postId]}),o.invalidateQueries({queryKey:["posts"]})},onError:t=>{}})};async function O(e){const o=await c.api.v0.comments.user[":userId"].$get({param:{userId:e.toString()}});if(!o.ok)throw new Error("Error getting comments by user id");const{comments:t}=await o.json();return t.map(E)}const me=e=>v({queryKey:["comments",e],queryFn:()=>O(e)});async function T(e){const o=await c.api.v0.comments.post.count[":postId"].$get({param:{postId:e.toString()}});if(!o.ok)throw new Error("Error getting comments by id");const{commentsLength:t}=await o.json();return t}const de=e=>v({queryKey:["comments-length",e],queryFn:()=>T(e)});async function W(e){const o=await c.api.v0.comments.user.comments[":username"].$get({param:{username:e.toString()}});if(!o.ok)throw new Error("Error getting comments by username");const{comments:t}=await o.json();return t.map(E)}const le=e=>v({queryKey:["user-comments",e],queryFn:()=>W(e)});async function _(e){const o=x(),t=await c.api.v0.votes.$post({json:e},o?{headers:{Authorization:`Bearer ${o}`}}:void 0);if(!t.ok){let r="There was an issue creating your vote :( We'll look into it ASAP!";try{const n=await t.json();n&&typeof n=="object"&&"message"in n&&(r=String(n.message))}catch(n){console.error("Failed to parse error response:",n)}throw new Error(r)}const i=await t.json();if(!i.vote)throw new Error("Invalid response from server");return i.vote}const Z=e=>{const o=h();return w({mutationFn:_,onSuccess:t=>{o.invalidateQueries({queryKey:["user-vote",t.postId,t.userId]}),o.invalidateQueries({queryKey:["votes-summary",t.postId]}),o.invalidateQueries({queryKey:["comment-votes",t.commentId]})},onError:t=>{}})};async function G(e){const o=await c.api.v0.votes[":postId"].$get({param:{postId:e.toString()}});if(!o.ok)throw new Error("Error getting votes by postId");const{votes:t}=await o.json();return t}const ye=e=>v({queryKey:["post-votes",e],queryFn:()=>G(e)});async function X(e){const o=x(),t=await c.api.v0.votes.update.$post({json:e},o?{headers:{Authorization:`Bearer ${o}`}}:void 0);if(!t.ok){let r="There was an issue updating your vote :( We'll look into it ASAP!";throw console.log(e),new Error(r)}const{vote:i}=await t.json();return i}const Y=e=>{const o=h();return w({mutationFn:X,onSuccess:t=>{o.invalidateQueries({queryKey:["comment-votes",t.commentId]}),o.invalidateQueries({queryKey:["user-vote",t.postId,t.userId]}),o.invalidateQueries({queryKey:["votes-summary",t.postId]})},onError:t=>{}})};async function H(e){const o=await c.api.v0.votes.comments[":commentId"].$get({param:{commentId:e.toString()}});if(!o.ok)throw new Error("Error getting comment votes by commentId");const{votes:t}=await o.json();return t}const ve=e=>v({queryKey:["comment-votes",e],queryFn:()=>H(e)});async function J(e){const o=await c.api.v0.votes.post.summary[":postId"].$get({param:{postId:e.toString()}});if(!o.ok)throw new Error("Error getting votes by postId");return await o.json()}const ee=e=>v({queryKey:["votes-summary",e],queryFn:()=>J(e)});async function te(e,o){const t=await c.api.v0.votes.post.user[":postId"][":userId"].$get({param:{postId:e.toString(),userId:o.toString()}});if(!t.ok)throw new Error("Error getting user vote by postId");return await t.json()}const oe=(e,o)=>v({queryKey:["user-vote",e,o],queryFn:()=>te(e,o)});function pe(e){const{mutate:o,isPending:t}=Z(),{mutate:i,isPending:r}=Y(),{user:n}=C(),d=q(),{data:y,isLoading:p,error:g}=k(ee(e.post.postId)),{data:m,isLoading:f,error:u}=k(oe(e.post.postId,n&&n.userId||""));function l(a,F,S){if(a.preventDefault(),a.stopPropagation(),!(t||r)){if(!n){d({to:"/login"});return}m&&m.voted?i({voteId:m.voteId,value:S}):n?o({postId:F.postId,value:S}):d({to:"/login"})}}return s.jsx("div",{children:s.jsxs("div",{className:"flex bg-[#3e3e3e] w-fit rounded-full py-1 justify-center",children:[n?f?s.jsx(s.Fragment,{children:"Loading..."}):u?s.jsx(s.Fragment,{children:"Error loading user vote"}):m?m.value===1?s.jsx("div",{onClick:a=>{l(a,e.post,0)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:r?"Updating...":s.jsx(K,{size:20})}):s.jsx("div",{onClick:a=>{l(a,e.post,1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:s.jsx(I,{size:20})}):s.jsx("div",{onClick:a=>{l(a,e.post,1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:t?"Voting...":s.jsx(I,{size:20})}):s.jsx("div",{onClick:a=>{l(a,e.post,1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:t?"Voting...":s.jsx(I,{size:20})}),s.jsx("div",{className:"font-semibold",children:p?s.jsx("div",{children:"Loading..."}):g?s.jsx("div",{children:"Error loading votes"}):y?y.score:0}),n?f?s.jsx(s.Fragment,{children:"Loading..."}):u?s.jsx(s.Fragment,{children:"Error loading user vote"}):m?m.value===-1?s.jsx("div",{onClick:a=>{l(a,e.post,0)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:r?"Updating...":s.jsx(b,{size:20})}):m.value===0?s.jsx("div",{onClick:a=>{l(a,e.post,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:r?"Updating...":s.jsx(j,{size:20})}):s.jsx("div",{onClick:a=>{l(a,e.post,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:r?"Updating...":s.jsx(j,{size:20})}):s.jsx("div",{onClick:a=>{l(a,e.post,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:t?"Voting...":s.jsx(j,{size:20})}):s.jsx("div",{onClick:a=>{l(a,e.post,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:t?"Voting...":s.jsx(j,{size:20})})]})})}function ge(e){const o=typeof e=="string"?new Date(e.replace(" ","T")+"Z"):e,t=Date.now();let i=Math.floor((t-o.getTime())/1e3);const r=new Intl.RelativeTimeFormat("en",{numeric:"auto"});if(i<60)return r.format(-i,"second");const n=Math.floor(i/60);if(n<60)return r.format(-n,"minute");const d=Math.floor(n/60);if(d<24)return r.format(-d,"hour");const y=Math.floor(d/24);if(y<30)return r.format(-y,"day");const p=Math.floor(y/30);if(p<12)return r.format(-p,"month");const g=Math.floor(p/12);return r.format(-g,"year")}function se(e){return M({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"},child:[]}]})(e)}function fe(e){const o=P.useRef(null),{user:t}=C(),{setEditPostModePointer:i}=N(),r=q(),{mutate:n,isPending:d}=V(),{data:y}=k(B(t&&t.userId||"")),p=!!y?.some(u=>u.postId===e.post.postId),{mutate:g,isPending:m}=A();function f(u){o.current&&!o.current.contains(u.target)&&e.setShowMenu(!1)}return P.useEffect(()=>(document.addEventListener("click",f),()=>document.removeEventListener("click",f)),[]),s.jsxs("div",{ref:o,className:"absolute top-12 right-2 py-2 px-5 rounded bg-[#222222] shadow-[0_0_15px_rgba(0,0,0,0.7)] z-40",children:[t&&e.post.userId===t.userId&&s.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[s.jsx(se,{size:20,className:"pt-1"}),s.jsx("div",{onClick:()=>{i(e.post.postId),r({to:`/posts/${e.post.postId}`}),e.setShowMenu(!1)},className:"ml-2",children:"Edit"})]}),p?s.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[s.jsx(Q,{size:20,className:"pt-1"}),s.jsx("div",{onClick:u=>{if(u.stopPropagation(),u.preventDefault(),!t)return r({to:"/login"});m||g({userId:t.userId||"",postId:e.post.postId},{onSuccess:()=>e.setShowMenu(!1)})},className:"ml-2",children:m?"Removing...":"Remove from saved"})]}):s.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[s.jsx(z,{size:20,className:"pt-1"}),s.jsx("div",{onClick:u=>{if(u.stopPropagation(),u.preventDefault(),!t)return r({to:"/login"});d||n({userId:t.userId||"",postId:e.post.postId},{onSuccess:()=>e.setShowMenu(!1)})},className:"ml-2",children:d?"Saving...":"Save"})]}),t&&e.post.userId===t.userId&&s.jsxs("div",{onClick:u=>{u.stopPropagation(),u.preventDefault(),e.setDeleteMode(!0),e.setShowMenu(!1)},className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[s.jsx($,{size:20,className:"pt-1 "}),s.jsx("div",{className:"ml-2",children:"Delete"})]})]})}export{se as F,fe as M,pe as V,de as a,ye as b,le as c,ge as d,ae as e,ce as f,me as g,ie as h,ve as i,Z as j,Y as k,ue as u};
