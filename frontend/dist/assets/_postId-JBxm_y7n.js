import{q as J,d as G,e as H,f as T,u as I,a as C,j as e,r as x,I as X,R as Y,c as Z,h as ee,i as te}from"./index-BX0ANxCy.js";import{u as w,g as se,a as ne,b as oe,c as re,e as ae,f as ie,h as de,i as q,j as le,k as ce,l as ue,d as L,F as V,M as me,V as xe}from"./Menu-Bu0CyBOA.js";import{g as fe}from"./users-JJXQP_fg.js";function pe(t){return{...t,createdAt:new Date(t.createdAt)}}async function he(t){const s=await T.api.v0.comments.$post({json:t});if(!s.ok){let c="There was an issue creating your comment :( We'll look into it ASAP!";try{const d=await s.json();d&&typeof d=="object"&&"message"in d&&(c=String(d.message))}catch(d){console.error("Failed to parse error response:",d)}throw new Error(c)}return await s.json()}const O=t=>{const s=G();return H({mutationFn:he,onSettled:()=>{s.invalidateQueries({queryKey:["comments"]})},onError:i=>{}})};async function ve(t){const s=await T.api.v0.comments[":postId"].$get({param:{postId:t.toString()}});if(!s.ok)throw new Error("Error getting comments by id");const{comments:i}=await s.json();return i.map(pe)}const je=t=>J({queryKey:["comments",t],queryFn:()=>ve(t)});function ge(t){const{data:s,isPending:i,isError:c}=w(se(t.comment.commentId)),{mutate:d}=ne(),{mutate:u}=oe(),{user:a}=I(),j=C();function f(n,l,h,v){n.preventDefault(),n.stopPropagation();const r=s&&s.find(g=>a&&g.userId===a.userId);a&&r?u({voteId:r.voteId,value:v}):a?d({userId:a&&a.userId||"",postId:l.postId,commentId:h.commentId,value:v}):j({to:"/login"})}return e.jsx("div",{children:c?e.jsx("div",{children:"Error fetching votes"}):i?e.jsx("div",{children:"Loading..."}):e.jsxs("div",{className:"flex w-fit rounded-full py-1 justify-center",children:[s.filter(n=>a&&n.userId===a.userId&&n.value===1).length>0?e.jsx("div",{onClick:n=>{n.stopPropagation(),n.preventDefault(),u({voteId:s.find(l=>l.postId===t.post.postId&&a&&l.userId===a.userId&&l.value===1).voteId,value:0})},className:"pr-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(re,{size:20})}):e.jsx("div",{onClick:n=>{f(n,t.post,t.comment,1)},className:"pr-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(ae,{size:20})}),e.jsx("div",{className:"",children:s.filter(n=>n.postId===t.post.postId).reduce((n,l)=>n+l.value,0)}),s.filter(n=>a&&n.userId===a.userId&&n.value===-1).length>0?e.jsx("div",{onClick:n=>{n.stopPropagation(),n.preventDefault(),u({voteId:s.find(l=>l.postId===t.post.postId&&a&&l.userId===a.userId&&l.value===-1).voteId,value:0})},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(ie,{size:20})}):e.jsx("div",{onClick:n=>{f(n,t.post,t.comment,-1)},className:"px-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:e.jsx(de,{size:20})})]})})}function ye(t){const s=x.useRef(null),{user:i}=I(),{setEditCommentModePointer:c}=q();C();function d(u){s.current&&!s.current.contains(u.target)&&t.setShowMenu(!1)}return x.useEffect(()=>(document.addEventListener("click",d),()=>document.removeEventListener("click",d)),[]),e.jsxs("div",{ref:s,className:"absolute top-12 right-2 py-2 px-5 rounded bg-[#222222] shadow-[0_0_15px_rgba(0,0,0,0.7)] z-40",children:[i&&t.comment.userId===i.userId&&e.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[e.jsx(le,{size:20,className:"pt-1"}),e.jsx("div",{onClick:()=>{c(t.comment.commentId),t.setShowMenu(!1)},className:"ml-2",children:"Edit"})]}),e.jsxs("div",{className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[e.jsx(ce,{size:20,className:"pt-1"}),e.jsx("div",{className:"ml-2",children:"Save"})]}),i&&t.comment.userId===i.userId&&e.jsxs("div",{onClick:u=>{u.stopPropagation(),u.preventDefault(),t.setDeleteMode(!0),t.setShowMenu(!1)},className:"flex py-2 hover:text-[#ffffff] cursor-pointer",children:[e.jsx(ue,{size:20,className:"pt-1 "}),e.jsx("div",{className:"ml-2",children:"Delete"})]})]})}function Q(t){const[s,i]=x.useState(!1),{user:c}=I(),[d,u]=x.useState(""),{mutate:a}=O(),j=C(),[f,n]=x.useState(!1),[l,h]=x.useState(!1);function v(r){if(r.preventDefault(),!c)return j({to:"/login"});const g=c.userId;a({userId:g,postId:t.post.postId,parentCommentId:t.comment.commentId,level:t.comment.level+1,content:d},{onSuccess:()=>u("")})}return e.jsxs("div",{className:"my-3",style:{paddingLeft:window.innerWidth>760?t.comment.level*25:t.comment.level*10},children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[e.jsx("div",{className:"font-bold",children:t.comment.username}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:L(t.post.createdAt)})]}),e.jsx("div",{children:t.comment.content}),e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"mr-3",children:e.jsx(ge,{post:t.post,comment:t.comment})}),e.jsxs("div",{onClick:()=>{c||j({to:"/login"}),i(!0)},className:"flex ml-2 cursor-pointer hover:text-cyan-500 transition-all ease-in-out duration-300",children:[e.jsx(X,{size:22}),e.jsx("div",{className:"ml-2",children:"Reply"})]}),c&&t.comment.userId===c.userId&&e.jsxs("div",{className:"relative",children:[e.jsx("div",{onClick:r=>{r.preventDefault(),r.stopPropagation(),n(!f)},className:"ml-3 px-2 pt-1.5 rounded-full hover:text-cyan-700 transition-all ease-in-out duration-300 cursor-pointer",children:e.jsx(V,{})}),f&&e.jsx(ye,{comment:t.comment,setDeleteMode:h,setShowMenu:n})]})]}),s&&e.jsxs("form",{onSubmit:v,className:`pl-5 py-2 my-5 ${s?"rounded-2xl":"rounded-full"} border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300`,children:[e.jsx("input",{type:"text",placeholder:"Add your reply",className:"outline-none",value:d,onChange:r=>u(r.target.value),required:!0}),e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:r=>{r.stopPropagation(),i(!1)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{className:"mx-2 px-2 py-1 rounded-full bg-red-500",children:"Comment"})]})]}),l&&e.jsxs("div",{className:"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-[#222222] p-6 rounded shadow-lg w-[90%] max-w-md text-center z-100",children:[e.jsx("div",{className:"text-2xl font-bold",children:"Delete Comment?"}),e.jsx("div",{className:"my-5",children:"Once you delete this comment, it can’t be restored."}),e.jsxs("div",{className:"my-5 flex justify-end",children:[e.jsx("div",{onClick:r=>{r.stopPropagation(),r.preventDefault()},className:"p-2 mr-1 bg-red-500 rounded text-white bold secondary-font font-bold cursor-pointer",children:"DELETE"}),e.jsx("div",{onClick:r=>{r.stopPropagation(),r.preventDefault(),h(!1)},className:"p-2 ml-1 bg-[#5c5c5c] rounded bold secondary-font font-bold cursor-pointer",children:"CANCEL"})]})]}),l&&e.jsx("div",{className:"fixed inset-0 bg-black opacity-50 z-60"}),t.comment.children?.map(r=>e.jsx(Q,{comment:r,post:t.post},r.commentId))]},t.comment.commentId)}function Ne(){const t=Y.useRouteContext(),{user:s}=I(),{data:i,isPending:c,error:d}=w(je(t.postId)),{data:u,isPending:a,error:j}=w(fe(t.userId)),[f,n]=x.useState(""),{mutate:l}=O(),h=C(),[v,r]=x.useState(!1),g=_(i&&i||[]),[P,S]=x.useState(!1),[E,b]=x.useState(!1),{mutate:B}=Z(),{editPostModePointer:U,setEditPostModePointer:M}=q(),{mutate:$}=ee(),[k,D]=x.useState(t.content),A=te();function _(o,F){const N=new Map;for(const m of o)N.set(m.commentId,{...m,children:[]});const y=[];for(const m of o){const p=N.get(m.commentId);if(m.parentCommentId==null){y.push(p);continue}const R=N.get(m.parentCommentId);if(!R){y.push(p);continue}R.children.push(p)}const W=(m,p)=>m.createdAt.getTime()-p.createdAt.getTime();function z(m){m.sort(W);for(const p of m)p.children.length&&z(p.children)}return z(y),y}function K(o){if(o.preventDefault(),!s)return h({to:"/login"});const F=s.userId;l({userId:F,postId:t.postId,content:f},{onSuccess:()=>n("")})}return e.jsxs("div",{className:"p-20 mx-auto w-full lg:w-[50%]",children:[e.jsxs("div",{className:"relative flex justify-between",children:[e.jsxs("div",{className:"flex text-[#bdbdbd] text-sm",children:[a?e.jsx("div",{children:"Loading..."}):j?e.jsx("div",{children:"Error loading author"}):e.jsx("div",{className:"font-bold",children:u.username}),e.jsx("div",{className:"px-1",children:"•"}),e.jsx("div",{children:L(t.createdAt)})]}),e.jsx("div",{className:"",children:e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),S(!P)},className:" absolute top-1 right-1 p-3 rounded-full hover:bg-[#575757] transition-all ease-in-out duration-300",children:e.jsx(V,{})})}),P&&e.jsx(me,{post:t,setDeleteMode:b,setShowMenu:S})]}),e.jsxs("div",{className:"text-4xl font-bold",children:[" ",t.title]}),U===t.postId?e.jsxs("div",{children:[e.jsx("textarea",{name:"content",id:"content",required:!0,className:"p-2 border border-[#c4c4c4] rounded my-2 w-full h-[300px]",placeholder:"content",value:k,onChange:o=>D(o.target.value)}),e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:o=>{o.stopPropagation(),M(0)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{onClick:()=>{$({postId:t.postId,content:k},{onSuccess:()=>{A.invalidate(),M(0)}})},className:"mx-2 px-2 py-1 rounded-full bg-cyan-700",children:"Save"})]})]}):e.jsx("div",{className:"my-10",children:e.jsx("div",{children:t.content})}),e.jsx(xe,{post:t}),e.jsxs("form",{onClick:()=>{s||h({to:"/login"}),r(!0)},onSubmit:K,className:`pl-5 py-2 my-5 ${v?"rounded-2xl":"rounded-full"} border border-[#5c5c5c] w-full hover:bg-[#383838] hover:border-[#818181] transition-all ease-in-out duration-300`,children:[e.jsx("input",{type:"text",placeholder:"Join the conversation",value:f,onChange:o=>n(o.target.value),required:!0,className:"outline-none"}),s&&t.userId===s.userId&&E&&e.jsxs("div",{className:"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-[#222222] p-6 rounded shadow-lg w-[90%] max-w-md text-center z-100",children:[e.jsx("div",{className:"text-2xl font-bold",children:"Delete Post?"}),e.jsx("div",{className:"my-5",children:"Once you delete this post, it can’t be restored."}),e.jsxs("div",{className:"my-5 flex justify-end",children:[e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),B({postId:t.postId},{onSuccess:()=>{A.invalidate(),b(!1),D("[This post has been deleted by the user]")}})},className:"p-2 mr-1 bg-red-500 rounded text-white bold secondary-font font-bold cursor-pointer",children:"DELETE"}),e.jsx("div",{onClick:o=>{o.stopPropagation(),o.preventDefault(),b(!1)},className:"p-2 ml-1 bg-[#5c5c5c] rounded bold secondary-font font-bold cursor-pointer",children:"CANCEL"})]})]}),s&&t.userId===s.userId&&E&&e.jsx("div",{className:"fixed inset-0 bg-black opacity-50 z-60"}),v&&e.jsxs("div",{className:"flex justify-end",children:[e.jsx("div",{onClick:o=>{o.stopPropagation(),r(!1)},className:"cursor-pointer px-2 py-1 rounded-full bg-[#383838]",children:"Cancel"}),e.jsx("button",{className:"mx-2 px-2 py-1 rounded-full bg-red-500",children:"Comment"})]})]}),d?e.jsx("div",{}):c?e.jsx("div",{}):g.map(o=>e.jsx(Q,{comment:o,post:t},o.commentId))]})}export{Ne as component};
